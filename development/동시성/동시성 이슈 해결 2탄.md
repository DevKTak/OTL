# 동시성 이슈 해결 2탄 - 여러가지 동시성 제어 방식들을 적용해볼게요
해당 코드는 ➽ [재고 프로젝트](https://github.com/DevKTak/stock)에서 확인 부탁드립니다.

# 동시성 이슈 해결 방법 (동시성 제어 방식)
## ✅ **동시성을 고려하지 않은 로직**
```java
@Entity
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Stock {

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;

	private Long productId;

	private Long quantity;

	public Stock(final Long productId, final Long quantity) {
		this.productId = productId;
		this.quantity = quantity;
	}

	public void decrease(final Long quantity) {
		if (this.quantity - quantity < 0) {
			throw new RuntimeException("재고가 부족합니다.");
		}
		this.quantity -= quantity;
	}
}
```

```java
@Service
@RequiredArgsConstructor
public class StockService {

	private final StockRepository stockRepository;

    @Transactional
	public void decrease(Long id, Long quantity) {
		// Stock 조회
		Stock stock = stockRepository.findById(id).orElseThrow(NoSuchElementException::new);

		// 재고 감소 시킨 뒤
		stock.decrease(quantity);

		// 갱신된 값을 저장
		stockRepository.saveAndFlush(stock); // saveAndFlush: 즉시 DB에 데이터를 반영
	}
}
```

```java
@Repository
public interface StockRepository extends JpaRepository<Stock, Long> {
}
```

### 테스트 코드
```java
@Test
@DisplayName("요청이 한개만 들어오기 때문에 성공하는 테스트 코드")
public void 재고감소() {
    // given

    // when
    stockService.decrease(1L, 1L);

    //then
    // 100 - 1 = 99
    Stock stock = stockRepository.findById(1L).orElseThrow();
    assertThat(stock.getQuantity()).isEqualTo(99);
}

@Test
/*
    - 해당 어노테이션을 붙이면 스프링의 테스트 컨텍스트 프레임워크에게 해당 클래스의 테스트에서
    애플리케이션 컨텍스트의 상태를 변경한다는 것을 알려준다.
    - 같은 Context를 사용하는 테스트간의 격리를 위해 사용
    - 테스트 케이스가 실행된 후에 컨텍스트가 재로딩되어 다른 테스트 케이스에 영향을 주지 않습니다.
*/
@DirtiesContext
@DisplayName("Race Condition이 발생")
public void 동시에_100개의_요청_Race_Condition_발생() throws InterruptedException {
    int threadCount = 100;

    // ExecutorService: 비동기로 실행하는 작업을 단순화하여 사용할 수 있게 도와줌
    ExecutorService executorService = Executors.newFixedThreadPool(32); // 스레드 풀의 개수 지정

    // 100개의 요청이 끝날때까지 기다려야하므로 CountDownLatch 활용
    // CountDownLatch: 다른 쓰레드에서 수행중인 작업이 완료될때 까지 대기할 수 있도록 도와주는 클래스
    CountDownLatch latch = new CountDownLatch(threadCount); // Latch 할 개수 지정

    for (int i = 0; i < threadCount; i++) { // 100개의 요청
        executorService.submit(() -> {
            try {
                stockService.decrease(1L, 1L);
            } finally {
                latch.countDown(); // countDown(): Latch 의 카운터가 1개씩 감소
            }
        });
    }
    latch.await(); // await(): Latch 의 카운터가 0이 될 때까지 기다림

    Stock stock = stockRepository.findById(1L).orElseThrow();

    // 예상대로 라면 100 - (1 * 100) = 0 이지만 RaceCondition 발생으로 인해 예상과 다른 결과가 나옴
    assertThat(stock.getQuantity()).isEqualTo(0);
}
```
<img width="939" alt="image" src="https://github.com/DevKTak/DevKTak/assets/68748397/1ba057b9-2dbd-4a74-b604-c89c59c3992e">

## ✅ **1. Application 레벨에서 해결하는 방법**
### 1. synchronized 키워드
```java
@Service
@RequiredArgsConstructor
// @Transactional(readOnly = true)
public class StockService {

	private final StockRepository stockRepository;

	// @Transactional
	public synchronized void decrease(Long id, Long quantity) {
		// Stock 조회
		Stock stock = stockRepository.findById(id).orElseThrow(NoSuchElementException::new);

		// 재고 감소 시킨 뒤
		stock.decrease(quantity);

		// 갱신된 값을 저장
		stockRepository.saveAndFlush(stock); // saveAndFlush: 즉시 DB에 데이터를 반영
	}
}
```

### 테스트 코드
```java
@Test
	@DirtiesContext
	@DisplayName("synchronize 키워드 활용")
	public void 동시에_100개의_요청_synchronized() throws InterruptedException {
		int threadCount = 100;

		ExecutorService executorService = Executors.newFixedThreadPool(32);

		CountDownLatch latch = new CountDownLatch(threadCount);

		for (int i = 0; i < threadCount; i++) {
			executorService.submit(() -> {
				try {
					stockService.decrease(1L, 1L);
				} finally {
					latch.countDown();
				}
			});
		}
		latch.await();

		Stock stock = stockRepository.findById(1L).orElseThrow();

		assertThat(stock.getQuantity()).isEqualTo(0);
	}
```
<img width="1053" alt="image" src="https://github.com/DevKTak/DevKTak/assets/68748397/4625e63a-e92e-40a5-90e3-1fe6c4951698">